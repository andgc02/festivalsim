{% extends "base.html" %}
{% from "components/stats_card.html" import stats_card %}
{% from "components/analytics_card.html" import analytics_card, metric_item %}
{% from "components/sidebar_card.html" import sidebar_card %}

{% block title %}{{ festival.name }} - Festival Simulator{% endblock %}

{% block content %}
<div class="dashboard-refactored" data-festival-id="{{ festival.id }}">
<!-- Festival Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-5 fw-bold text-primary mb-2">
                    <i class="fas fa-music me-3"></i>{{ festival.name }}
                </h1>
                <p class="lead text-muted mb-0">
                    <i class="fas fa-clock me-2"></i>{{ festival.days_remaining }} days until festival
                    <span class="mx-3">â€¢</span>
                    <i class="fas fa-star me-2"></i>Reputation: {{ festival.reputation }}/100
                </p>
            </div>
            <div class="text-end">
                <div class="badge bg-success fs-6 px-3 py-2">
                    <i class="fas fa-circle me-2"></i>Active
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    {{ stats_card('budgetDisplay', "${:,.0f}".format(festival.budget), 'Current Budget', 'fa-dollar-sign') }}
    {{ stats_card('daysRemaining', festival.days_remaining, 'Days Remaining', 'fa-calendar') }}
    {{ stats_card('ticketsSold', '0', 'Tickets Sold', 'fa-ticket-alt') }}
    {{ stats_card('artistsCount', '0', 'Artists Hired', 'fa-microphone') }}
    {{ stats_card('vendorsCount', '0', 'Vendors Hired', 'fa-store') }}
    {{ stats_card('daysUntilFestival', festival.days_remaining, 'Days Until Festival', 'fa-clock') }}
</div>

<!-- Main Content Area -->
<div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="showArtists()" style="background-color: transparent !important; border-color: #0d6efd !important; color: #0d6efd !important;">
                            <i class="fas fa-microphone me-2"></i>Hire Artists
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-success w-100" onclick="showVendors()" style="background-color: transparent !important; border-color: #198754 !important; color: #198754 !important;">
                            <i class="fas fa-store me-2"></i>Hire Vendors
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-warning w-100" onclick="showMarketing()" style="background-color: transparent !important; border-color: #ffc107 !important; color: #ffc107 !important;">
                            <i class="fas fa-bullhorn me-2"></i>Launch Marketing
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="btn btn-outline-info w-100" onclick="advanceTime()" style="background-color: transparent !important; border-color: #0dcaf0 !important; color: #0dcaf0 !important;">
                            <i class="fas fa-clock me-2"></i>Advance Time
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Festival Overview -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Festival Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <canvas id="revenueChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6 mb-4">
                        <canvas id="budgetChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6 mb-4">
                        <canvas id="artistPopularityChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6 mb-4">
                        <canvas id="vendorQualityChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-analytics me-2"></i>Analytics Dashboard
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Financial Metrics -->
                    <div class="col-md-6 mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-dollar-sign me-2"></i>Financial Metrics
                        </h6>
                        <div class="row">
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Total Revenue</div>
                                <div class="fw-bold" id="totalRevenue">$0</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Budget Used</div>
                                <div class="fw-bold" id="budgetUsed">0%</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Avg Ticket Price</div>
                                <div class="fw-bold" id="avgTicketPrice">$0</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">ROI</div>
                                <div class="fw-bold" id="roi">0%</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Expected Revenue</div>
                                <div class="fw-bold" id="expectedRevenue">$0</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Expected Attendance</div>
                                <div class="fw-bold" id="expectedAttendance">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="col-md-6 mb-4">
                        <h6 class="text-success mb-3">
                            <i class="fas fa-trophy me-2"></i>Performance Metrics
                        </h6>
                        <div class="row">
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Festival Score</div>
                                <div class="fw-bold" id="festivalScore">0/100</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Festival Reputation</div>
                                <div class="fw-bold" id="festivalReputation">{{ festival.reputation }}/100</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Artist Satisfaction</div>
                                <div class="fw-bold" id="artistSatisfactionScore">N/A</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Vendor Satisfaction</div>
                                <div class="fw-bold" id="vendorSatisfactionScore">N/A</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Avg Artist Popularity</div>
                                <div class="fw-bold" id="avgArtistPopularity">0</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Avg Vendor Quality</div>
                                <div class="fw-bold" id="avgVendorQuality">0</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Marketing Effectiveness</div>
                                <div class="fw-bold" id="marketingEffectiveness">100%</div>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="small text-muted">Marketing Budget</div>
                                <div class="fw-bold" id="marketingBudget">${{ festival.marketing_budget }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Operational Metrics -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-warning mb-3">
                            <i class="fas fa-cogs me-2"></i>Operational Metrics
                        </h6>
                        <div class="row">
                            <div class="col-3 mb-2">
                                <div class="small text-muted">Total Artists</div>
                                <div class="fw-bold" id="totalArtists">0</div>
                            </div>
                            <div class="col-3 mb-2">
                                <div class="small text-muted">Total Vendors</div>
                                <div class="fw-bold" id="totalVendors">0</div>
                            </div>
                            <div class="col-3 mb-2">
                                <div class="small text-muted">Active Marketing</div>
                                <div class="fw-bold" id="activeMarketing">0</div>
                            </div>
                            <div class="col-3 mb-2">
                                <div class="small text-muted">Pending Events</div>
                                <div class="fw-bold" id="pendingEvents">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Artist Synergies -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-magic me-2"></i>Artist Synergies
                </h5>
            </div>
            <div class="card-body">
                <div id="synergiesContainer">
                    <p class="text-muted">No synergies available yet. Hire more artists to unlock synergies!</p>
                </div>
            </div>
        </div>

        <!-- Vendor Relationships -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-handshake me-2"></i>Vendor Relationships
                </h5>
            </div>
            <div class="card-body">
                <div id="vendorRelationshipsContainer">
                    <p class="text-muted">No vendor relationships to display. Hire more vendors to see relationships!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Festival Navigation -->
        {% call sidebar_card('Festivals', 'fa-festival') %}
            <div class="list-group">
                {% for f in festivals %}
                <a href="{{ url_for('dashboard', festival_id=f.id) }}" 
                   class="list-group-item list-group-item-action {% if f.id == festival.id %}active{% endif %}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ f.name }}</h6>
                        <small>{{ f.days_remaining }} days</small>
                    </div>
                    <small>Budget: ${{ "{:,.0f}".format(f.budget) }}</small>
                </a>
                {% endfor %}
            </div>
        {% endcall %}

        <!-- Events -->
        {% call sidebar_card('Events & Alerts', 'fa-exclamation-triangle', 'warning', 'dark') %}
            <div id="eventsContainer">
                <p class="text-muted text-center">No events at the moment.</p>
            </div>
        {% endcall %}

        <!-- Risk Assessment -->
        {% call sidebar_card('Risk Assessment', 'fa-exclamation-triangle', 'danger') %}
            <div id="riskAssessmentContainer">
                <p class="text-muted">Loading risk assessment...</p>
            </div>
        {% endcall %}

        <!-- Marketing Recommendations -->
        {% call sidebar_card('Marketing Tips', 'fa-lightbulb', 'info') %}
            <div id="marketingRecommendationsContainer">
                <p class="text-muted">Loading recommendations...</p>
            </div>
        {% endcall %}

        <!-- Approaching Artists -->
        <div class="card mb-4" id="approachingArtistsCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-star me-2"></i>Artists Want to Join!
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">Your festival's popularity is attracting talent!</p>
                <div id="approachingArtistsList">
                    <p class="text-muted text-center">Loading approaching artists...</p>
                </div>
            </div>
        </div>

        <!-- Hired Artists -->
        {% call sidebar_card('Hired Artists', 'fa-microphone') %}
            <div id="artistsList">
                <p class="text-muted text-center">No artists hired yet.</p>
            </div>
        {% endcall %}

        <!-- Hired Vendors -->
        {% call sidebar_card('Hired Vendors', 'fa-store') %}
            <div id="vendorsList">
                <p class="text-muted text-center">No vendors hired yet.</p>
            </div>
        {% endcall %}

        <!-- Approaching Vendors -->
        <div class="card mt-4" id="approachingVendorsCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-star me-2"></i>Vendors Want to Join!
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">Your festival's success is attracting vendors!</p>
                <div id="approachingVendorsList">
                    <p class="text-muted text-center">Loading approaching vendors...</p>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Include the modals from the original dashboard -->
{% include 'components/dashboard_modals.html' %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/components/DashboardManager.js') }}"></script>
<script>
// Initialize dashboard with the new modular approach
let dashboardManager;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard initialized');
    
    const festivalElement = document.querySelector('[data-festival-id]');
    if (!festivalElement) {
        console.error('No valid festival ID found');
        showAlert('Error: No festival data available', 'danger');
        return;
    }
    
    const festivalId = parseInt(festivalElement.dataset.festivalId);
    dashboardManager = new DashboardManager(festivalId);
    
    // Load initial data
    dashboardManager.loadFestivalData();
    
    // Set up periodic data refresh
    setInterval(() => dashboardManager.loadFestivalData(), 60000);
});

// Global functions that interact with the dashboard manager
async function loadFestivalData(forceRefresh = false) {
    if (dashboardManager) {
        await dashboardManager.loadFestivalData(forceRefresh);
    }
}

async function advanceTime() {
    if (!dashboardManager) return;
    
    try {
        showLoading();
        const result = await apiCall(`/api/advance_time/${dashboardManager.festivalId}`, 'POST');
        
        if (result.success) {
            showAlert('Time advanced successfully!', 'success');
            await dashboardManager.loadFestivalData(true);
        } else {
            showAlert('Failed to advance time: ' + result.error, 'danger');
        }
    } catch (error) {
        console.error('Error advancing time:', error);
        showAlert('Error advancing time: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}

// Navigation functions - these are called from the navbar
function showArtists() {
    console.log('showArtists called');
    loadAvailableArtists();
    const modal = new bootstrap.Modal(document.getElementById('artistsModal'));
    modal.show();
}

function showVendors() {
    console.log('showVendors called');
    loadAvailableVendors();
    const modal = new bootstrap.Modal(document.getElementById('vendorsModal'));
    modal.show();
}

function showMarketing() {
    console.log('showMarketing called');
    loadMarketingCampaigns();
    const modal = new bootstrap.Modal(document.getElementById('marketingModal'));
    modal.show();
}

function showLayout() {
    console.log('showLayout called');
    const modal = new bootstrap.Modal(document.getElementById('layoutModal'));
    modal.show();
}

function showSchedule() {
    console.log('showSchedule called');
    const modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    modal.show();
}

async function loadAvailableArtists() {
    try {
        console.log('Loading available artists...');
        const artists = await apiCall('/api/artists');
        const container = document.getElementById('availableArtistsList');
        
        container.innerHTML = artists.map(artist => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">${artist.name}</h5>
                            <p class="card-text">
                                <strong>Genre:</strong> ${artist.genre}<br>
                                <strong>Popularity:</strong> ${artist.popularity}/100<br>
                                <strong>Performance Duration:</strong> ${artist.performance_duration} minutes<br>
                                <strong>Stage Requirements:</strong> ${artist.stage_requirements || 'None'}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="mb-2">
                                <strong class="text-primary">${formatCurrency(artist.fee)}</strong>
                            </div>
                            <button class="btn btn-primary" onclick="hireArtist(${artist.id})">
                                <i class="fas fa-plus me-2"></i>Hire Artist
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        console.log('Artists loaded successfully');
    } catch (error) {
        console.error('Error loading artists:', error);
        showAlert('Error loading artists: ' + error.message, 'danger');
    }
}

async function loadAvailableVendors() {
    try {
        console.log('Loading available vendors...');
        const vendors = await apiCall('/api/vendors');
        const container = document.getElementById('availableVendorsList');
        
        container.innerHTML = vendors.map(vendor => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">${vendor.name}</h5>
                            <p class="card-text">
                                <strong>Type:</strong> ${vendor.type}<br>
                                <strong>Category:</strong> ${vendor.category}<br>
                                <strong>Commission Rate:</strong> ${(vendor.commission_rate * 100).toFixed(1)}%
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="mb-2">
                                <strong class="text-primary">${formatCurrency(vendor.fee)}</strong>
                            </div>
                            <button class="btn btn-success" onclick="hireVendor(${vendor.id})">
                                <i class="fas fa-plus me-2"></i>Hire Vendor
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        console.log('Vendors loaded successfully');
    } catch (error) {
        console.error('Error loading vendors:', error);
        showAlert('Error loading vendors: ' + error.message, 'danger');
    }
}

async function loadMarketingCampaigns() {
    try {
        console.log('Loading marketing campaigns...');
        const campaigns = await apiCall('/api/marketing/campaigns');
        const container = document.getElementById('marketingCampaignsList');
        
        container.innerHTML = campaigns.map(campaign => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">${campaign.name}</h5>
                            <p class="card-text">
                                <strong>Type:</strong> ${campaign.type.replace('_', ' ').toUpperCase()}<br>
                                <strong>Target Audience:</strong> ${campaign.target_audience || 'General'}<br>
                                <strong>Effectiveness:</strong> ${((campaign.effectiveness - 1) * 100).toFixed(0)}% boost<br>
                                <strong>Duration:</strong> ${campaign.duration_days} days<br>
                                <small class="text-muted">${campaign.description || ''}</small>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="mb-2">
                                <strong class="text-primary">${formatCurrency(campaign.cost)}</strong>
                            </div>
                            <button class="btn btn-warning" onclick="launchMarketing(${campaign.id})">
                                <i class="fas fa-rocket me-2"></i>Launch Campaign
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        console.log('Marketing campaigns loaded successfully');
    } catch (error) {
        console.error('Error loading marketing campaigns:', error);
        showAlert('Error loading marketing campaigns: ' + error.message, 'danger');
    }
}

async function hireArtist(artistId) {
    try {
        console.log('Hiring artist:', artistId);
        showLoading();
        const result = await apiCall('/api/artists/hire', 'POST', { 
            artist_id: artistId,
            festival_id: dashboardManager ? dashboardManager.festivalId : 1
        });
        
        if (result.success) {
            showAlert('Artist hired successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('artistsModal')).hide();
            await dashboardManager.loadFestivalData(true);
        } else {
            if (result.error && result.error.includes('Insufficient budget')) {
                showAlert('Insufficient budget to hire this artist!', 'danger');
            } else {
                showAlert(result.error || 'Failed to hire artist', 'danger');
            }
        }
    } catch (error) {
        console.error('Error hiring artist:', error);
        showAlert('Error hiring artist: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}

async function hireVendor(vendorId) {
    try {
        console.log('Hiring vendor:', vendorId);
        showLoading();
        const result = await apiCall('/api/vendors/hire', 'POST', { 
            vendor_id: vendorId,
            festival_id: dashboardManager ? dashboardManager.festivalId : 1
        });
        
        if (result.success) {
            showAlert('Vendor hired successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('vendorsModal')).hide();
            await dashboardManager.loadFestivalData(true);
        } else {
            if (result.error && result.error.includes('Insufficient budget')) {
                showAlert('Insufficient budget to hire this vendor!', 'danger');
            } else {
                showAlert(result.error || 'Failed to hire vendor', 'danger');
            }
        }
    } catch (error) {
        console.error('Error hiring vendor:', error);
        showAlert('Error hiring vendor: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}

async function launchMarketing(campaignId) {
    try {
        console.log('Launching marketing campaign:', campaignId);
        showLoading();
        const result = await apiCall('/api/marketing/launch', 'POST', { 
            campaign_id: campaignId,
            festival_id: dashboardManager ? dashboardManager.festivalId : 1
        });
        
        if (result.success) {
            showAlert('Marketing campaign launched successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('marketingModal')).hide();
            await dashboardManager.loadFestivalData(true);
        } else {
            showAlert(result.error || 'Failed to launch campaign', 'danger');
        }
    } catch (error) {
        console.error('Error launching marketing campaign:', error);
        showAlert('Error launching campaign: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}

// Pause menu functions
function showPauseMenu() {
    console.log('showPauseMenu called');
    console.log('Current festival ID:', dashboardManager ? dashboardManager.festivalId : 'Not initialized');
    console.log('Current festival data:', dashboardManager ? dashboardManager.festivalData : 'Not available');
    
    updatePauseMenuInfo();
    
    const modal = document.getElementById('pauseModal');
    if (modal) {
        console.log('Pause modal found, showing...');
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
    } else {
        console.error('Pause modal not found');
    }
}

function updatePauseMenuInfo() {
    if (dashboardManager && dashboardManager.festivalData && dashboardManager.festivalData.festival) {
        const festival = dashboardManager.festivalData.festival;
        
        const nameElement = document.getElementById('currentFestivalName');
        const locationElement = document.getElementById('currentFestivalLocation');
        const dateElement = document.getElementById('currentFestivalDate');
        const budgetElement = document.getElementById('currentFestivalBudget');
        const statusElement = document.getElementById('currentFestivalStatus');
        const daysElement = document.getElementById('currentFestivalDays');
        
        if (nameElement) nameElement.textContent = festival.name || 'Unknown';
        if (locationElement) locationElement.textContent = festival.location || 'Unknown';
        if (dateElement) dateElement.textContent = festival.date ? new Date(festival.date).toLocaleDateString() : 'Not set';
        if (budgetElement) budgetElement.textContent = formatCurrency(festival.current_budget || festival.budget || 0);
        
        if (statusElement) {
            const status = festival.status || 'active';
            statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusElement.className = `badge bg-${status === 'active' ? 'success' : 'warning'}`;
        }
        
        if (daysElement) {
            let daysUntil;
            if (festival.current_game_date) {
                daysUntil = Math.ceil((new Date(festival.date) - new Date(festival.current_game_date)) / (1000 * 60 * 60 * 24));
            } else {
                daysUntil = Math.ceil((new Date(festival.date) - new Date()) / (1000 * 60 * 60 * 24));
            }
            daysElement.textContent = daysUntil > 0 ? daysUntil : 'Today!';
        }
    } else {
        console.log('No festival data available for pause menu, loading...');
        if (dashboardManager) {
            dashboardManager.loadFestivalData(true).then(() => {
                setTimeout(updatePauseMenuInfo, 100);
            }).catch(error => {
                console.error('Failed to load festival data for pause menu:', error);
                const elements = ['currentFestivalName', 'currentFestivalLocation', 'currentFestivalDate', 'currentFestivalBudget', 'currentFestivalStatus', 'currentFestivalDays'];
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = 'Error loading data';
                });
            });
        }
    }
}

// Utility functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount || 0);
}

function showLoading() {
    // Implement loading indicator
    console.log('Loading...');
}

function hideLoading() {
    // Hide loading indicator
    console.log('Loading complete');
}

// Pause modal functions
function confirmNewFestival() {
    if (confirm('Are you sure you want to start a new festival? This will save your current progress.')) {
        window.location.href = '/new_game';
    }
}

function showStatistics() {
    // For now, just show an alert. This could be expanded to show detailed statistics
    alert('Statistics feature coming soon!');
}

function confirmExit() {
    if (confirm('Are you sure you want to exit? Your progress will be saved.')) {
        window.close();
    }
}

function exportFestival() {
    // For now, just show an alert. This could be expanded to export festival data
    alert('Export feature coming soon!');
}

function showHelp() {
    // For now, just show an alert. This could be expanded to show help documentation
    alert('Help documentation coming soon!');
}

function showOptions() {
    // For now, just show an alert. This could be expanded to show game options
    alert('Game options coming soon!');
}

function resumeGame() {
    // Hide the pause modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('pauseModal'));
    if (modal) {
        modal.hide();
    }
}

function saveOptions() {
    // Save game options (for now, just show a success message)
    const modal = bootstrap.Modal.getInstance(document.getElementById('optionsModal'));
    if (modal) {
        modal.hide();
    }
    showAlert('Options saved successfully!', 'success');
}

// Modal focus management to fix accessibility warnings
function setupModalFocusManagement() {
    // Handle modal focus when opened
    document.addEventListener('shown.bs.modal', function (event) {
        const modal = event.target;
        const firstFocusable = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (firstFocusable) {
            firstFocusable.focus();
        }
    });

    // Handle modal focus when closed
    document.addEventListener('hidden.bs.modal', function (event) {
        // Return focus to the element that opened the modal
        const triggerElement = document.querySelector('[data-bs-target="#' + event.target.id + '"]');
        if (triggerElement) {
            triggerElement.focus();
        }
    });
}

// Initialize modal focus management when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setupModalFocusManagement();
    
    // Force button colors
    forceButtonColors();
});

// Function to force button colors
function forceButtonColors() {
    // Force outline button colors
    const outlineButtons = document.querySelectorAll('.btn-outline-primary, .btn-outline-success, .btn-outline-warning, .btn-outline-info, .btn-outline-secondary, .btn-outline-danger');
    outlineButtons.forEach(button => {
        if (button.classList.contains('btn-outline-primary')) {
            button.style.backgroundColor = 'transparent';
            button.style.borderColor = '#0d6efd';
            button.style.color = '#0d6efd';
        } else if (button.classList.contains('btn-outline-success')) {
            button.style.backgroundColor = 'transparent';
            button.style.borderColor = '#198754';
            button.style.color = '#198754';
        } else if (button.classList.contains('btn-outline-warning')) {
            button.style.backgroundColor = 'transparent';
            button.style.borderColor = '#ffc107';
            button.style.color = '#ffc107';
        } else if (button.classList.contains('btn-outline-info')) {
            button.style.backgroundColor = 'transparent';
            button.style.borderColor = '#0dcaf0';
            button.style.color = '#0dcaf0';
        } else if (button.classList.contains('btn-outline-secondary')) {
            button.style.backgroundColor = 'transparent';
            button.style.borderColor = '#6c757d';
            button.style.color = '#6c757d';
        } else if (button.classList.contains('btn-outline-danger')) {
            button.style.backgroundColor = 'transparent';
            button.style.borderColor = '#dc3545';
            button.style.color = '#dc3545';
        }
    });
    
    // Force solid button colors
    const solidButtons = document.querySelectorAll('.btn-primary, .btn-success, .btn-warning, .btn-info, .btn-danger');
    solidButtons.forEach(button => {
        if (button.classList.contains('btn-primary')) {
            button.style.backgroundColor = '#0d6efd';
            button.style.borderColor = '#0d6efd';
            button.style.color = '#fff';
        } else if (button.classList.contains('btn-success')) {
            button.style.backgroundColor = '#198754';
            button.style.borderColor = '#198754';
            button.style.color = '#fff';
        } else if (button.classList.contains('btn-warning')) {
            button.style.backgroundColor = '#ffc107';
            button.style.borderColor = '#ffc107';
            button.style.color = '#000';
        } else if (button.classList.contains('btn-info')) {
            button.style.backgroundColor = '#0dcaf0';
            button.style.borderColor = '#0dcaf0';
            button.style.color = '#000';
        } else if (button.classList.contains('btn-danger')) {
            button.style.backgroundColor = '#dc3545';
            button.style.borderColor = '#dc3545';
            button.style.color = '#fff';
        }
    });
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    .sidebar-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border-radius: 15px !important;
        padding: 15px !important;
        margin-bottom: 20px !important;
        text-align: center !important;
        min-height: 100px !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        overflow: hidden !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        border: none !important;
    }
    
    .stats-number {
        font-size: 2rem !important;
        font-weight: bold !important;
        margin-bottom: 5px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        line-height: 1.1 !important;
        flex-shrink: 0 !important;
        color: white !important;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;
    }
    
    .stats-label {
        font-size: 0.85rem !important;
        opacity: 0.9 !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
        color: white !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
    }
    
    .stats-card i {
        color: white !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
    }
    
    .analytics-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border: none;
    }
    
    .event-option-btn {
        transition: all 0.2s;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .event-option-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .event-option-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
    }
    
    .alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
    }
    
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    /* Button styling fixes */
    .btn {
        color: inherit;
        border: 1px solid transparent;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        vertical-align: middle;
        cursor: pointer;
        user-select: none;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.25rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .btn-primary {
        color: #fff;
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .btn-primary:hover {
        color: #fff;
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }
    
    .btn-success {
        color: #fff;
        background-color: #198754;
        border-color: #198754;
    }
    
    .btn-success:hover {
        color: #fff;
        background-color: #157347;
        border-color: #146c43;
    }
    
    .btn-warning {
        color: #000;
        background-color: #ffc107;
        border-color: #ffc107;
    }
    
    .btn-warning:hover {
        color: #000;
        background-color: #ffca2c;
        border-color: #ffc720;
    }
    
    .btn-info {
        color: #000;
        background-color: #0dcaf0;
        border-color: #0dcaf0;
    }
    
    .btn-info:hover {
        color: #000;
        background-color: #31d2f2;
        border-color: #25cff2;
    }
    
    .btn-outline-primary {
        color: #0d6efd;
        border-color: #0d6efd;
        background-color: transparent;
    }
    
    .btn-outline-primary:hover {
        color: #fff;
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .btn-outline-success {
        color: #198754;
        border-color: #198754;
        background-color: transparent;
    }
    
    .btn-outline-success:hover {
        color: #fff;
        background-color: #198754;
        border-color: #198754;
    }
    
    .btn-outline-warning {
        color: #ffc107;
        border-color: #ffc107;
        background-color: transparent;
    }
    
    .btn-outline-warning:hover {
        color: #000;
        background-color: #ffc107;
        border-color: #ffc107;
    }
    
    .btn-outline-info {
        color: #0dcaf0;
        border-color: #0dcaf0;
        background-color: transparent;
    }
    
    .btn-outline-info:hover {
        color: #000;
        background-color: #0dcaf0;
        border-color: #0dcaf0;
    }
    
    .btn-outline-secondary {
        color: #6c757d;
        border-color: #6c757d;
        background-color: transparent;
    }
    
    .btn-outline-secondary:hover {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
    }
    
    .btn-outline-danger {
        color: #dc3545;
        border-color: #dc3545;
        background-color: transparent;
    }
    
    .btn-outline-danger:hover {
        color: #fff;
        background-color: #dc3545;
        border-color: #dc3545;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
    }
    
    .btn-close {
        box-sizing: content-box;
        width: 1em;
        height: 1em;
        padding: 0.25em 0.25em;
        color: #000;
        background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
        border: 0;
        border-radius: 0.25rem;
        opacity: 0.5;
    }
    
    .btn-close:hover {
        color: #000;
        text-decoration: none;
        opacity: 0.75;
    }
    
    /* Ensure text is visible in cards */
    .card {
        background-color: #fff;
        color: #212529;
    }
    
    .card-body {
        color: #212529;
    }
    
    .card-title {
        color: #212529;
    }
    
    .card-text {
        color: #212529;
    }
    
    /* Ensure modals have proper styling */
    .modal-content {
        background-color: #fff;
        color: #212529;
    }
    
    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .modal-body {
        background-color: #fff;
        color: #212529;
    }
    
    .modal-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    /* Completely reset and override base template button styles */
    .dashboard-refactored .btn {
        background: none !important;
        background-image: none !important;
        background-color: transparent !important;
        border: 1px solid !important;
        border-radius: 0.25rem !important;
        color: inherit !important;
        text-shadow: none !important;
        box-shadow: none !important;
        transform: none !important;
        font-weight: 500 !important;
        padding: 0.375rem 0.75rem !important;
        font-size: 1rem !important;
        line-height: 1.5 !important;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
    }
    
    /* Remove any gradient backgrounds */
    .dashboard-refactored .btn::before,
    .dashboard-refactored .btn::after {
        display: none !important;
    }
    
    /* Force specific colors for each button type */
    .dashboard-refactored .btn-primary {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: #fff !important;
    }
    
    .dashboard-refactored .btn-success {
        background-color: #198754 !important;
        border-color: #198754 !important;
        color: #fff !important;
    }
    
    .dashboard-refactored .btn-warning {
        background-color: #ffc107 !important;
        border-color: #ffc107 !important;
        color: #000 !important;
    }
    
    .dashboard-refactored .btn-info {
        background-color: #0dcaf0 !important;
        border-color: #0dcaf0 !important;
        color: #000 !important;
    }
    
    .dashboard-refactored .btn-outline-primary {
        background-color: transparent !important;
        border-color: #0d6efd !important;
        color: #0d6efd !important;
    }
    
    .dashboard-refactored .btn-outline-success {
        background-color: transparent !important;
        border-color: #198754 !important;
        color: #198754 !important;
    }
    
    .dashboard-refactored .btn-outline-warning {
        background-color: transparent !important;
        border-color: #ffc107 !important;
        color: #ffc107 !important;
    }
    
    .dashboard-refactored .btn-outline-info {
        background-color: transparent !important;
        border-color: #0dcaf0 !important;
        color: #0dcaf0 !important;
    }
    
    .dashboard-refactored .btn-outline-secondary {
        background-color: transparent !important;
        border-color: #6c757d !important;
        color: #6c757d !important;
    }
    
    .dashboard-refactored .btn-outline-danger {
        background-color: transparent !important;
        border-color: #dc3545 !important;
        color: #dc3545 !important;
    }
    
    /* Ensure stats card icons are visible */
    .stats-card i {
        color: white !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
    }
    
    /* Fix text overflow and cutoff issues throughout the UI */
    
    /* General text overflow handling */
    .text-overflow-ellipsis {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Stats cards - prevent text cutoff */
    .stats-card {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        padding: 8px !important;
        display: block !important;
        overflow: visible !important;
    }
    
    .stats-number {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
        height: auto !important;
        min-height: auto !important;
        font-size: 1.5rem !important;
        line-height: 1.2 !important;
        margin-bottom: 4px !important;
        display: block !important;
        overflow: visible !important;
    }
    
    .stats-label {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
        height: auto !important;
        min-height: auto !important;
        font-size: 0.8rem !important;
        line-height: 1.2 !important;
        margin-bottom: 0 !important;
        display: block !important;
        overflow: visible !important;
    }
    
    /* Card titles and text */
    .card-title {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.3;
        max-width: 100%;
    }
    
    .card-text {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.5;
        max-width: 100%;
    }
    
    /* Button text handling */
    .btn {
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.2;
        min-height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    
    .btn-sm {
        min-height: 2rem;
        font-size: 0.875rem;
        line-height: 1.1;
    }
    
    /* Modal content text handling */
    .modal-title {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.3;
        max-width: 100%;
    }
    
    .modal-body {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.5;
    }
    
    /* List items and navigation */
    .nav-link {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        white-space: normal;
        line-height: 1.3;
    }
    
    .list-group-item {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.4;
    }
    
    /* Form elements */
    .form-label {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.3;
        max-width: 100%;
    }
    
    .form-control {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.5;
    }
    
    /* Badge and small elements */
    .badge {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        white-space: normal;
        line-height: 1.2;
        max-width: 100%;
    }
    
    /* Alert messages */
    .alert {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.5;
    }
    
    /* Table cells */
    .table td, .table th {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        line-height: 1.4;
        max-width: 200px; /* Prevent extremely wide cells */
    }
    
    /* Responsive text sizing - simplified */
    @media (max-width: 576px) {
        .stats-number {
            font-size: 1.2rem !important;
        }
        
        .stats-label {
            font-size: 0.7rem !important;
        }
    }
    
    @media (max-width: 768px) {
        .stats-number {
            font-size: 1.3rem !important;
        }
        
        .stats-label {
            font-size: 0.75rem !important;
        }
    }
</style>
{% endblock %} 